parameters:
    - name: subscriptionName
      type: string
    - name: resourceGroupName
      type: string
    - name: storageAccountName
      type: string

steps:
  - task: AzureCLI@2
    displayName: Add IP to SA network allow list in ${{ parameters.storageAccountName }}
    inputs:
      azureSubscription: '${{parameters.subscriptionName}}'
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        $storageAccountName = "${{ parameters.storageAccountName }}"
        $resourceGroupName = "${{ parameters.resourceGroupName }}"

        Write-Host "Starting Task: Add IP to SA network allow list"

        $ip = Invoke-RestMethod -Method GET -Uri https://api.ipify.org

        Write-Host "Using IP: $ip ..."

        az storage account network-rule add --account-name $storageAccountName -g $resourceGroupName --ip-address $ip