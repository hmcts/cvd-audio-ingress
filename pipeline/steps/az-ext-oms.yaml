parameters:
  - name: subscription
    type: string
  - name: vmNames
    type: object
    default: []
  - name: vmRgName
    type: string

steps:
  - task: AzureCLI@2
    displayName: Get Settings for OMS Extension
    name: omsSettings
    condition: always()
    inputs:
      azureSubscription: ${{ parameters.subscription }}
      scriptType: pscore
      scriptLocation: inlineScript
      inlineScript: |
        $rgName="$env:WS_RG"
        $workspaceName="$env:WS_NAME"
        $workspaceSubscriptionName="$env:WS_SUB_NAME"

        az account set -s $workspaceSubscriptionName

        $key=az monitor log-analytics workspace get-shared-keys --resource-group $rgName --workspace-name $workspaceName --query "primarySharedKey" -o tsv
        $id=az monitor log-analytics workspace show --resource-group $rgName --workspace-name $workspaceName -o tsv --query "customerId"

        Write-Host "ID: $id"

                                                $subId=az account show --query "id" -o tsv
                                                Write-Host "subId: $subId"

        $settings = [PSCustomObject]@{
          workspaceId           = $id
        }
        
        $settingsJson = $settings | ConvertTo-Json -Compress -Depth 100
        $settingsJson = $settingsJson -replace "`"", "\`""

        $protectedSettings = [PSCustomObject]@{
          workspaceKey           = $key
        }
        $protectedSettingsJson = $protectedSettings | ConvertTo-Json -Compress -Depth 100
        $protectedSettingsJson = $protectedSettingsJson -replace "`"", "\`""
                                                    Write-Host "1"
                                                    $extTags = [PSCustomObject]@{
                                                        application     = 'Cloud'
                                                        BuiltFrom = 'cvp-audio-ingress'
                                                        BusinessArea    = 'Cross-Cutting'
                                                        environment = 'staging'
                                                        Platform = ''
                                                        Video = ''
                                                    }
                                                    $extTagsJson = $extTags | ConvertTo-Json -Compress -Depth 100
                                                    $extTagsJson = $extTagsJson -replace "`"", "\`""
                                                    Write-Host "2"
                                                    Write-Host $protectedSettingsJson

        Write-Host "##vso[task.setvariable variable=settingsJson;isOutput=true]$settingsJson"
        Write-Host "##vso[task.setvariable variable=protectedSettingsJson;isOutput=true;issecret=true]$protectedSettingsJson"
                                                    Write-Host "##vso[task.setvariable variable=extTagsJson;isOutput=true;issecret=true]$extTagsJson"

  - ${{ each vm in parameters.vmNames }}:
    - template: ./az-install-ext.yaml
      parameters:
        subscription: ${{ parameters.subscription }}
        rgName: ${{ parameters.vmRgName }}
        vmName: ${{ vm }}
        extName: "OmsAgentForLinux"
        extPublisher: "Microsoft.EnterpriseCloud.Monitoring"
        settingsJson: $(omsSettings.settingsJson)
        protectedSettingsJson: $(omsSettings.protectedSettingsJson)
        extTagsJson: $(omsSettings.extTagsJson)