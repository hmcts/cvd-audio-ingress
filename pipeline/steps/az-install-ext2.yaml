parameters:
  - name: subscription
    type: string
  - name: rgName
    type: string
  - name: vmName
    type: string
  - name: extName
    type: string
  - name: extPublisher
    type: string
  - name: restApiPutBody2Json
    type: string
    default: ""

steps:
  - task: AzureCLI@2
    displayName: Install ${{ parameters.extName }} to ${{ parameters.vmName }}
    condition: always()
    continueOnError: true
    inputs:
      azureSubscription: ${{ parameters.subscription }}
      scriptType: pscore
      scriptLocation: inlineScript
      inlineScript: |
        $rgName="${{ parameters.rgName }}"
        $vmName="${{ parameters.vmName }}"
        $extName="${{ parameters.extName }}"
        $extPublisher="${{ parameters.extPublisher }}"
        $restBody2 = '${{ parameters.restApiPutBody2Json }}'

        if ($null -eq $restBody2 -or $restBody2 -eq ""){
          Write-Host "restBody2 is either null or empty"
          $restBody2="{}"
        }
                      
        Try {
          
          $subscriptionId = az account show --query "id" -o tsv
          $restUri = -join("https://management.azure.com/subscriptions/$subscriptionId/resourceGroups/$rgName/providers/Microsoft.Compute/virtualMachines/$vmName/extensions/", "$extName", "?api-version=2021-11-01")
          Write-Host "Installing $extName from $extPublisher using REST API"
          Write-Host "restUri: $restUri"
          Write-Host "restBody2:"
          Write-Host "$restBody2"

          az rest --method put --uri $restUri --body $restBody2

        } Catch {
          Write-Host "Failed"
          Write-Host "restUri: $restUri"
          Write-Host "rgName: $rgName   vmName: $vmName"
        }

        
