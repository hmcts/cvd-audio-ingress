parameters:
  - name: env
    type: string
  - name: pipelineStart
    type: boolean

steps:
  - task: AzureCLI@2
    displayName: Start and Stop Vms during pipeline run
    name: startStopVm
    condition: always()
    inputs:
      azureSubscription: ${{variables.subscriptionName}}
      scriptType: pscore
      scriptLocation: inlineScript
      inlineScript: |
        Write-Output "1"
        $turn_off_vm_post_run="$env:TURN_OFF_VM_POST_RUN"
        Write-Output "2"
        $resourcegroup="cvp-recordings-${{parameters.env}}-rg"
        Write-Output "3"
        $pipelineStart=${{parameters.pipelineStart}}
        Write-Output "4"

        Write-Output "Should state be altered by AzDo pipeline: $turn_off_vm_post_run"
        Write-Output ""

        $rgExists = az group exists --name $resourcegroup
        if ( $rgExists )
        {
          Write-Output "$resourcegroup exists in subscription"
          $vmList = az vm list --resource-group $resourcegroup  --query "[].{name:name}"  | ConvertFrom-Json
          $vmListCnt=$vmList.Count 
          Write-Output "$vmListCnt found in resource group"
          foreach ($vm in $vmList) {
              $vmName= $vm.name
              $vmDetails = az vm get-instance-view --name $vmName --resource-group $resourcegroup | ConvertFrom-Json
              $statusVm = $vmDetails.instanceView.statuses[1].Code
              Write-Output "Initial status for VM '$vmName'= $statusVm"

              if ( $pipelineStart eq $true -And "PowerState/deallocated","PowerState/deallocating","PowerState/stopped","PowerState/stopping","PowerState/unknown" -contains $statusVm){
                if ( $turn_off_vm_post_run )
                {
                  Write-Output "Deallocating VM '$vmName'"
                  az vm deallocate --name $vmName --resource-group $resourcegroup
                  Write-Output ""
                }
              } 
              elseif ( $pipelineStart eq $false -And "PowerState/running","PowerState/starting","PowerState/unknown" -contains $statusVm){
                if ( $turn_off_vm_post_run )
                {
                  Write-Output "Deallocating VM '$vmName'"
                  az vm deallocate --name $vmName --resource-group $resourcegroup
                  Write-Output ""
                }
              }  
              else {
                  Write-Output "The VM '$vmName' is in the desired state"
              }
          }
        }else
        {
            Write-Output "$resourcegroup does not exist in subscription"
        }
        
        Write-Output "Stage finished: Turning Vm Off"